+++
title = ""
date = "2020-06-08T02:30:06+03:00"
draft = true
+++

Сегодня расскажу про одну особенность http-парсера nodejs, ...

На проекте, над которым я работаю, потребовалось хранить очень много редиректов и в случае, если запрос матчится по
базе данных - отдавать **301** ответ с нужным заголовком `Location`, тем самым, пользователь отправлялся по нужному
адресу.

Поскольку сервис был достаточно небольшим (буквально 1 роут), решено было его написать на ванильном `nodejs`, без
фреймворков. Сервис располагался как прослойка после балансировщика, но до основного бэкенда.

В случае, если этот сервис возвращает не 301 код, то запрос проксируется на бэкенд, чтобы пользователь увидел нормальную
ошибку, а не json.

После деплоя всё было хорошо первые несколько месяцев, а потом в логе nginx'а стали наблюдаться следующие ошибки:

```
...upstream prematurely closed connection while reading response header from upstream...
``` 

Появлялись они, естественно, не стабильно. При нагрузке на продакшене в 70-100 rps, было замечено от 5 до 20 ошибок в
минуту и практически 0 ночью. В самих запросах не было ничего не обычного:

```
127.0.0.1 - dbmanager [20/Nov/2017:18:52:17 +0000] "GET /i/want/get/some/redirect/here _ HTTP/1.1" 404 188 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:47.0) Gecko/20100101 Firefox/47.0"
```

Поскольку все ошибки пробрасывались на бэк