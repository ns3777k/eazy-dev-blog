+++
title = "HPE_INVALID_CONSTANT –≤ nodejs"
date = "2020-06-24T17:30:06+03:00"
tags = ["nodejs", "backend", "http"]
+++

–ü–æ —Ä–∞–±–æ—Ç–µ —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å –æ–¥–Ω–∏–º –∫–µ–π—Å–æ–º, –æ –∫–æ—Ç–æ—Ä–æ–º —Å–µ–≥–æ–¥–Ω—è —Ä–∞—Å—Å–∫–∞–∂—É. –°–µ—Ä–≤–∏—Å –±—ã–ª –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ **nodejs 10** –∏ –ø–µ—Ä–µ–¥ –Ω–∏–º —Å—Ç–æ—è–ª
**nginx**. –í –∫–∞–∫–æ–π-—Ç–æ –º–æ–º–µ–Ω—Ç, –≤ **access.log** –Ω–∞—á–∞–ª–∏ –ø–æ—è–≤–ª—è—Ç—å—Å—è –æ—à–∏–±–∫–∏ `400 Bad Request`:

```text
127.0.0.1 - worker [20/Nov/2017:18:52:17 +0000] "GET /go/online _ HTTP/1.1" 400 188 "-" "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:47.0) Gecko/20100101 Firefox/47.0"
```

–ê –≤ **error.log** —Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: `...upstream prematurely closed connection while reading response header from upstream...`.

–ê–Ω–∞–ª–∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–æ. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–∏—Å–∞–ª–æ –≤ –ª–æ–≥, –Ω–æ
**nginx** –ø–æ –ø—Ä–µ–∂–Ω–µ–º—É –æ—Ç–¥–∞–≤–∞–ª `400` –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã. –£—Ç—Ä–æ–º –∏—Ö –±—ã–ª–æ –Ω–∞ –ø–æ—Ä—è–¥–æ–∫ –±–æ–ª—å—à–µ (–æ—Ç 5 –¥–æ 20 –æ—à–∏–±–æ–∫ –≤ –º–∏–Ω—É—Ç—É
–ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ 70 - 100 `rps`) —á–µ–º –Ω–æ—á—å—é (1-2 –æ—à–∏–±–æ–∫).

–í —É–ø—Ä–æ—â–µ–Ω–Ω–æ–º –≤–∏–¥–µ, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—ã–≥–ª—è–¥–µ–ª–æ —Ç–∞–∫ (–Ω–∞—Ç–∏–≤–Ω–∞—è –Ω–æ–¥–∞ –±–µ–∑ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞):

```javascript
const http = require('http');

const server = http.createServer((request, response) => {
    console.log(`serving ${request.url}`);
    response.end(`I'm from server`);
});

server.on('error', err => {
    console.error(err);
});

server.listen(3000, () => {
    console.log(`Server is listening on port 3000`);
});
```

–ï—Å–ª–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥ **nginx** –∏ –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Ç–æ –Ω–∞ –ø–µ—Ä–≤—ã–π –≤–∑–≥–ª—è–¥ –≤—Å–µ –≤—ã–≥–ª—è–¥–∏—Ç —Ö–æ—Ä–æ—à–æ –∏ –µ—Å–ª–∏ –ø–æ–¥–Ω—è—Ç—å —Ç–∞–∫–æ–π –ª–æ–∫–∞–ª—å–Ω–æ –∏
–∫—É—Ä–ª–∞–Ω—É—Ç—å —Ç–æ—Ç –∂–µ –ø—É—Ç—å –∏–∑ –ª–æ–≥–∞ –∫–æ–º–∞–Ω–¥–æ–π `curl -s 127.1/go/online`, —Ç–æ –æ—à–∏–±–∫–∏ –Ω–µ –±—É–¥–µ—Ç. –í —á–µ–º —Ç–æ–≥–¥–∞ –ø—Ä–æ–±–ª–µ–º–∞? 

–í—ã—à–µ–ø—Ä–∏–≤–µ–¥–µ–Ω–Ω—ã–π –∫–æ–¥ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–ª—É—à–∞–µ—Ç –æ—à–∏–±–∫–∏. –í **99%**, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–º —è–≤–ª—è–µ—Ç—Å—è —Å–ª—É—à–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ `error`, –Ω–æ —ç—Ç–æ —Ç–æ—Ç
—Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ —Å–µ—Ä–≤–µ—Ä, –ø—Ä–∏ –æ—à–∏–±–∫–µ, [—ç–º–∏—Ç—Ç–∏—Ç –Ω–µ error, –∞ clientError](https://github.com/nodejs/node/blob/v10.21.0/lib/_http_server.js#L526).
–ü–æ—Å–ª–µ —Ñ–∏–∫—Å–∞, –≤ –ª–æ–≥ –Ω–∞—á–∞–ª–æ —Å—ã–ø–∞—Ç—å—Å—è —Ç–∞–∫–æ–µ:

```text
{ Error: Parse Error, bytesParsed: 15, code: 'HPE_INVALID_CONSTANT', rawPacket: <Buffer 47 45 54 ...> }
```

–î–µ–ª–æ –Ω–µ–º–Ω–æ–≥–æ –¥–≤–∏–Ω—É–ª–æ—Å—å —Å –º–µ—Å—Ç–∞, –Ω–æ –≤—Å–µ —Ä–∞–≤–Ω–æ, –¥–æ –∫–æ–Ω—Ü–∞ –Ω–µ –±—ã–ª–æ –ø–æ–Ω—è—Ç–Ω–æ –æ—Ç–∫—É–¥–∞ –≤–∑—è–ª–∞—Å—å –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ —Ç–æ–ª—å–∫–æ
–ø–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ –±—É—Ñ—Ñ–µ—Ä–∞ –≤ —Å—Ç—Ä–æ–∫—É, —Å–∏—Ç—É–∞—Ü–∏—è –ø—Ä–æ—è—Å–Ω–∏–ª–∞—Å—å:

```text
GET /go/onlinetest _ HTTP/1.1
Host: 127.1:3000
```

–û–∫–∞–∑–∞–ª–æ—Å—å, —á—Ç–æ –≤ –ª–æ–≥–µ **nginx** –ø—Ä–æ–±–µ–ª –±—ã–ª –Ω–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º –ø—É—Ç–∏ –æ—Ç –¥—Ä—É–≥–æ–π —á–∞—Å—Ç–∏ –ª–æ–≥–∞, –∞ —ç—Ç–æ –±—ã–ª–∞ –Ω–µ—ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —á–∞—Å—Ç—å
–ø—É—Ç–∏. –í —Ç–∞–∫–∏—Ö —Å–ª—É—á–∞—è—Ö **nodejs** [–æ—Ç–≤–µ—á–∞–µ—Ç —Å—Ä–∞–∑—É 400 Bad Request](https://github.com/nodejs/node/blob/v10.21.0/lib/_http_server.js#L528).

–î–æ, –∫–∞–∂–µ—Ç—Å—è, 9–π –≤–µ—Ä—Å–∏–∏, **nodejs** –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ **nginx** –¥—É–º–∞–ª, —á—Ç–æ –∞–ø—Å—Ç—Ä–∏–º —É–ø–∞–ª üòï
[–§–∏–∫—Å–∏–ª–æ—Å—å —Ç—É—Ç](https://github.com/nodejs/node/pull/15324).