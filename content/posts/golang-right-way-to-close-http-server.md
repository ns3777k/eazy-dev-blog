+++
title = "–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ http-—Å–µ—Ä–≤–µ—Ä–∞ –≤ golang"
date = "2021-01-11T01:47:40+03:00"
tags = ["golang", "backend"]
+++

–ü—Ä–µ–∂–¥–µ —á–µ–º –∑–∞–∫—Ä—ã–≤–∞—Ç—å http-—Å–µ—Ä–≤–µ—Ä, —Ä–∞–∑–±–µ—Ä–µ–º—Å—è –∫–∞–∫ –Ω—É–∂–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚òùÔ∏è –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ **golang**
–º–Ω–æ–≥–∏–µ –≤–µ—â–∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –ø–∏—Å–∞—Ç—å —Ä—É–∫–∞–º–∏ –∏ –ø–µ—Ä–≤–æ–µ –∏–∑ —ç—Ç–æ–≥–æ ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤.

## –°–∏–≥–Ω–∞–ª—ã

–°–∏–≥–Ω–∞–ª—ã —ç—Ç–æ –æ–¥–Ω–æ –∏–∑ —Å—Ä–µ–¥—Å—Ç–≤ –º–µ–∂–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è (IPC). –ö –ø—Ä–∏–º–µ—Ä—É, –∫–æ–≥–¥–∞ –º—ã –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –Ω–∞–∂–∏–º–∞–µ–º
`Ctrl` + `C`, –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ—Å—ã–ª–∞–µ—Ç —Å–∏–≥–Ω–∞–ª `SIGINT` –ø—Ä–æ—Ü–µ—Å—Å—É —Å –ø—Ä–æ—Å—å–±–æ–π –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è. –ü–æ–º–∏–º–æ —ç—Ç–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞, –Ω—É–∂–Ω–æ
–∏–º–µ—Ç—å –≤ –≤–∏–¥—É –µ—â–µ `SIGTERM`, —á—Ç–æ –≤ –ø—Ä–∏–Ω—Ü–∏–ø–µ —Ç–æ–∂–µ —Å–∞–º–æ–µ, —á—Ç–æ –∏ `SIGINT`, –Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **–Ω–µ** —Å —Ç–µ—Ä–º–∏–Ω–∞–ª–∞. –û–±–∞ —ç—Ç–∏—Ö
—Å–∏–≥–Ω–∞–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å –º–æ–∂–µ—Ç –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–∞–∫–∏–µ-–ª–∏–±–æ –¥–µ–π—Å—Ç–≤–∏—è (–∑–∞–∫—Ä—ã—Ç—å –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä—ã, –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —á—Ç–æ-—Ç–æ –∏ —Ç.–¥.) –∏
–∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è. –≠—Ç–æ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è **Graceful shutdown**. –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∞–∂–Ω—ã–π –¥–ª—è –Ω–∞—Å —Å–∏–≥–Ω–∞–ª - `SIGKILL`, –Ω–æ –µ–≥–æ —É–∂–µ –Ω–µ–ª—å–∑—è –æ—Ç–ª–æ–≤–∏—Ç—å, –æ–Ω —É–±–∏–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –¥–∞–≤–∞—è –µ–º—É
–≤—Ä–µ–º–µ–Ω–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è. **Kubernetes** –∏ –¥—Ä—É–≥–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Å–Ω–∞—á–∞–ª–∞ `SIGTERM`, –∂–¥—É—Ç 10+ —Å–µ–∫—É–Ω–¥ –∏ –ø–æ—Ç–æ–º
–Ω–µ—â–∞–¥–Ω–æ —É–±–∏–≤–∞—é—Ç —á–µ—Ä–µ–∑ `SIGKILL`. –ë–æ–π–ª–µ—Ä–ø–ª–µ–π—Ç –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è —Å–∏–≥–Ω–∞–ª–∞ –≤ golang –æ–±—ã—á–Ω–æ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:

```golang
func handleSignals(cancel context.CancelFunc) {
	c := make(chan os.Signal, 1)
	signal.Notify(c, os.Interrupt, syscall.SIGTERM)

	<-c
	cancel()
}
```

–ù–∞ –≤—Ö–æ–¥ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è `cancel`-—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ–Ω—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ **–≤—Å–µ–≥–æ** –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–∞.

## HTTP-—Å–µ—Ä–≤–µ—Ä

–°–æ–∑–¥–∞—Ç—å http-—Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–æ—Å—Ç–æ:

```golang
server := &http.Server{Addr: config.ListenAddr, Handler: h.Router}
```

–°–ª–æ–∂–Ω–µ–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –µ–≥–æ –∑–∞–∫—Ä—ã—Ç—å. –î–ª—è –Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏–º —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –µ–≥–æ –∑–∞–ø—É—Å—Ç–∏—Ç:

```golang
func run(ctx context.Context) error {
    return server.ListenAndServe()
}
```

–ö–∞–∑–∞–ª–æ—Å—å –±—ã, –Ω–∞ —ç—Ç–æ–º –º–æ–∂–Ω–æ –∑–∞–∫–æ–Ω—á–∏—Ç—å üí™ –ù–æ –Ω–µ—Ç. –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ –æ—á–µ–Ω—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –∏ –¥–∞–ª—å—à–µ –º—ã –±—É–¥–µ–º –µ–µ
–ø—Ä–æ–∫–∞—á–∏–≤–∞—Ç—å. –ù–∞—á–Ω–µ–º —Å —Ç–æ–≥–æ, —á—Ç–æ `run` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É –µ—Å–ª–∏ –æ–Ω–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∞. –ù–æ `ListenAndServe` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–Ω–µ nil**
–¥–∞–∂–µ –µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –±—ã–ª –∑–∞–∫—Ä—ã—Ç —É—Å–ø–µ—à–Ω–æ:

```golang
func run(ctx context.Context) error {
    err := server.ListenAndServe()
    if err == http.ErrServerClosed {
		return nil
	}
    
    return err
}
```

–ù–æ –∫–∞–∫ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ? –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ –º—ã **–æ–±—ã—á–Ω–æ** –¥–µ–ª–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ 1 —Å–ª—É—á–∞–µ ‚Äî –∫–æ–≥–¥–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
–æ—Ç–º–µ–Ω–∏–ª–∏ (–∫ –ø—Ä–∏–º–µ—Ä—É –∏–∑-–∑–∞ —Å–∏–≥–Ω–∞–ª–∞). –î–ª—è –Ω–∞—à–µ–≥–æ –ø—Ä–∏–º–µ—Ä–∞, –º—ã –æ—Å—Ç–∞–≤–∏–º —Ñ—É–Ω–∫—Ü–∏—é `run` –±–ª–æ–∫–∏—Ä—É—é—â–µ–π, –¥–æ–±–∞–≤–∏–º –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—Ç–º–µ–Ω—ã
–∏ **graceful shutdown** —Å —Ç–∞–π–º–∞—É—Ç–æ–º –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö —Ç–µ–∫—É—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:

```golang
func run(ctx context.Context) error {
    go func() {
		<-ctx.Done()

		graceCtx, graceCancel := context.WithTimeout(context.Background(), 5 * time.Second)
		defer graceCancel()

		if err := server.Shutdown(graceCtx); err != nil {
		    // log, ...
		}
	}()
    
    err := server.ListenAndServe()
    if err == http.ErrServerClosed {
		return nil
	}
    
    return err
}
```

`server.Shutdown` –∑–∞—Å—Ç–∞–≤–∏—Ç —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ—Å—Ç–∞—Ç—å –ø—Ä–∏–Ω–∏–º–∞—Ç—å –Ω–æ–≤—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –¥–∞—Å—Ç 5 —Å–µ–∫—É–Ω–¥ —É–∂–µ –∞–∫—Ç–∏–≤–Ω—ã–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º
–∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è. –ó–¥–µ—Å—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—Å–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –∫—Ä–æ–º–µ 1 –¥–µ—Ç–∞–ª–∏ ‚Äî –∫–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `server.Shutdown`, `server.ListenAndServe`
–º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º –Ω—É–∂–Ω–æ —É—Å–ø–µ—Ç—å –æ—Ç—Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –º—ã –∑–∞–∫–æ–Ω—á–∏–º
–∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã. –ß—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–º, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç
–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—ã—Ö–æ–¥ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏, –ø–æ–∫–∞ –≤ –Ω–µ–≥–æ —á—Ç–æ-—Ç–æ –Ω–µ –∑–∞–ø–∏—à—É—Ç, –∞ –ø–∏—Å–∞—Ç—å –±—É–¥–µ–º —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ `server.Shutdown`.
–§–∏–Ω–∞–ª—å–Ω—ã–π –≤–∏–¥ —Ñ—É–Ω–∫—Ü–∏–∏:

```golang
func run(ctx context.Context) error {
    httpShutdownCh := make(chan struct{})

    go func() {
		<-ctx.Done()

		graceCtx, graceCancel := context.WithTimeout(context.Background(), 5 * time.Second)
		defer graceCancel()

		if err := server.Shutdown(graceCtx); err != nil {
		    // log, ...
		}
		
		httpShutdownCh <- struct{}{}
	}()
    
    err := server.ListenAndServe()
    <-httpShutdownCh
    
    if err == http.ErrServerClosed {
		return nil
	}
    
    return err
}
```

–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö –≤ –∫–∞–Ω–∞–ª–µ ‚Äî –ø—É—Å—Ç–æ–π `struct` –¥–ª—è –º–∏–∫—Ä–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏, –ø–æ—Ç–æ–º—É –æ–Ω –Ω–µ –∑–∞–Ω–∏–º–∞–µ—Ç –ø–∞–º—è—Ç—å.
